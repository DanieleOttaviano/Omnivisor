From 3667dd519dc31df63010a6e05070e91464daa545 Mon Sep 17 00:00:00 2001
From: Daniele Ottaviano <daniele.ottaviano@tum.de>
Date: Fri, 5 Sep 2025 16:49:44 +0200
Subject: [PATCH] This allows to tag memory regions read-only, denying
 userspace to map them writable. Default remains read/write.

Signed-off-by: Daniele Ottaviano <daniele.ottaviano@tum.de>
---
 drivers/uio/uio_core.c     | 9 +++++++++
 include/linux/uio_driver.h | 2 ++
 2 files changed, 11 insertions(+)

diff --git a/drivers/uio/uio_core.c b/drivers/uio/uio_core.c
index e51a7e987..b61d99bcd 100644
--- a/drivers/uio/uio_core.c
+++ b/drivers/uio/uio_core.c
@@ -834,6 +834,15 @@ static int uio_mmap(struct file *filep, struct vm_area_struct *vma)
 		goto out;
 	}
 
+	if (idev->info->mem[mi].readonly) {
+		if (vma->vm_flags & VM_WRITE) {
+			ret = -EINVAL;
+			goto out;
+		}
+
+		vma->vm_flags &= ~VM_MAYWRITE;
+	}
+
 	if (idev->info->mmap) {
 		ret = idev->info->mmap(idev->info, vma);
 		goto out;
diff --git a/include/linux/uio_driver.h b/include/linux/uio_driver.h
index 47c5962b8..e7a101e47 100644
--- a/include/linux/uio_driver.h
+++ b/include/linux/uio_driver.h
@@ -31,6 +31,7 @@ struct uio_map;
  * @offs:               offset of device memory within the page
  * @size:		size of IO (multiple of page size)
  * @memtype:		type of memory addr points to
+ * @readonly:		true of region is read-only
  * @internal_addr:	ioremap-ped version of addr, for driver internal use
  * @map:		for use by the UIO core only.
  */
@@ -40,6 +41,7 @@ struct uio_mem {
 	unsigned long		offs;
 	resource_size_t		size;
 	int			memtype;
+	bool			readonly;
 	void __iomem		*internal_addr;
 	struct uio_map		*map;
 };
-- 
2.39.5

